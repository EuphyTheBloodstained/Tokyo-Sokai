<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>フリックで避けろゲーム</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* スクロールを禁止 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #333;
            font-family: 'Arial', sans-serif;
            color: #eee;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        canvas {
            background-color: #000;
            display: block;
            border: 2px solid #555;
        }

        #scoreDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 28px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200; /* 最前面に表示 */
        }

        .game-screen h1 {
            font-size: 48px;
            margin-bottom: 40px;
            color: cyan;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }

        .game-screen h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #fff;
        }

        .game-screen button {
            margin: 10px;
            padding: 15px 30px;
            font-size: 28px;
            cursor: pointer;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 70%; /* ボタンの幅を調整 */
            max-width: 300px; /* 最大幅を設定 */
        }

        .game-screen button:active {
            transform: translateY(2px);
        }

        #gameOverScreen {
            background-color: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            font-size: 32px;
            line-height: 1.6;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            border: 2px solid cyan;
        }

        #gameOverScreen button {
            margin-top: 30px;
            padding: 12px 25px;
            font-size: 24px;
            cursor: pointer;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        #gameOverScreen button:active {
            transform: translateY(2px);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="scoreDisplay">スコア: 0</div>

    <div id="startScreen" class="game-screen">
        <h1>フリックで避けろ！</h1>
        <h2>難易度を選択</h2>
        <button id="easyButton">やさしい</button>
        <button id="normalButton">ふつう</button>
        <button id="hardButton">むずかしい</button>
    </div>

    <div id="gameOverScreen" class="game-screen" style="display: none;">
        ゲームオーバー！<br>
        <span id="finalScore"></span><br>
        <button id="restartButton">リスタート</button>
        <button id="backToTitleButton">タイトルに戻る</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const finalScoreDisplay = document.getElementById('finalScore');
            const easyButton = document.getElementById('easyButton');
            const normalButton = document.getElementById('normalButton');
            const hardButton = document.getElementById('hardButton');
            const restartButton = document.getElementById('restartButton');
            const backToTitleButton = document.getElementById('backToTitleButton');

            // キャンバスサイズをウィンドウに合わせる
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // ゲームの状態変数
            let player = {
                x: canvas.width / 2 - 25,
                y: canvas.height - 80,
                width: 50,
                height: 50,
                color: 'lime',
                speed: 10
            };

            let obstacles = [];
            let score = 0;
            let isGameOver = false;
            let lastObstacleTime = 0;
            let currentOBSTACLE_INTERVAL = 0;
            let currentOBSTACLE_SPEED = 0;

            // 難易度設定
            const difficultySettings = {
                easy: {
                    interval: 1000, // 障害物出現間隔（ミリ秒）
                    speed: 2 // 障害物落下速度
                },
                normal: {
                    interval: 700,
                    speed: 4
                },
                hard: {
                    interval: 400,
                    speed: 6
                }
            };

            // 難易度調整に関する定数 (ゲーム中に徐々に難しくなる部分)
            const SPEED_INCREASE_AMOUNT = 0.5;
            const INTERVAL_DECREASE_AMOUNT = 30;
            const DIFFICULTY_THRESHOLD = 10;
            const MAX_OBSTACLE_SPEED = 12;
            const MIN_OBSTACLE_INTERVAL = 100;

            let touchStartX = 0;

            // ゲームのリセットと開始（難易度に基づいて初期化）
            function startGame(difficulty) {
                currentOBSTACLE_INTERVAL = difficultySettings[difficulty].interval;
                currentOBSTACLE_SPEED = difficultySettings[difficulty].speed;

                player.x = canvas.width / 2 - 25;
                obstacles = [];
                score = 0;
                isGameOver = false;
                lastObstacleTime = performance.now();
                scoreDisplay.textContent = `スコア: ${score}`;
                startScreen.style.display = 'none'; // 初期画面を非表示
                gameOverScreen.style.display = 'none'; // ゲームオーバー画面を非表示
                gameLoop(); // ゲームループを開始
            }

            // 描画
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // キャンバスをクリア

                // 自機を描画
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.width, player.height);

                // 障害物を描画
                obstacles.forEach(obstacle => {
                    ctx.fillStyle = obstacle.color;
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                });

                scoreDisplay.textContent = `スコア: ${score}`;
            }

            // 更新
            function update() {
                if (isGameOver) return;

                // 障害物の生成
                if (performance.now() - lastObstacleTime > currentOBSTACLE_INTERVAL) {
                    const obstacleWidth = 35 + Math.random() * 45;
                    const obstacleHeight = 35 + Math.random() * 45;
                    const obstacleX = Math.random() * (canvas.width - obstacleWidth);
                    obstacles.push({
                        x: obstacleX,
                        y: -obstacleHeight,
                        width: obstacleWidth,
                        height: obstacleHeight,
                        color: 'red'
                    });
                    lastObstacleTime = performance.now();
                }

                // 障害物の移動と衝突判定
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    const obstacle = obstacles[i];
                    obstacle.y += currentOBSTACLE_SPEED;

                    // 衝突判定 (AABB衝突検出)
                    if (player.x < obstacle.x + obstacle.width &&
                        player.x + player.width > obstacle.x &&
                        player.y < obstacle.y + obstacle.height &&
                        player.y + player.height > obstacle.y) {
                        isGameOver = true;
                        finalScoreDisplay.textContent = `最終スコア: ${score}`;
                        gameOverScreen.style.display = 'flex'; // ゲームオーバー画面を表示
                        return;
                    }

                    // 画面外に出た障害物を削除し、スコア加算
                    if (obstacle.y > canvas.height) {
                        obstacles.splice(i, 1);
                        score++;

                        // スコアが難易度上昇の閾値に達したら難易度アップ
                        if (score % DIFFICULTY_THRESHOLD === 0 && score !== 0) {
                            currentOBSTACLE_SPEED = Math.min(MAX_OBSTACLE_SPEED, currentOBSTACLE_SPEED + SPEED_INCREASE_AMOUNT);
                            currentOBSTACLE_INTERVAL = Math.max(MIN_OBSTACLE_INTERVAL, currentOBSTACLE_INTERVAL - INTERVAL_DECREASE_AMOUNT);
                        }
                    }
                }
            }

            // ゲームループ
            function gameLoop() {
                update();
                draw();

                if (!isGameOver) {
                    requestAnimationFrame(gameLoop);
                }
            }

            // タッチイベントリスナー
            canvas.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // スクロールを防ぐ
                const touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;

                player.x += deltaX * 0.5;

                // 画面端での制限
                if (player.x < 0) player.x = 0;
                if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

                touchStartX = touchCurrentX; // 次のフレームのために現在の位置を保存
            });

            // --- ボタンイベントリスナー ---
            easyButton.addEventListener('click', () => startGame('easy'));
            normalButton.addEventListener('click', () => startGame('normal'));
            hardButton.addEventListener('click', () => startGame('hard'));
            restartButton.addEventListener('click', () => startGame(currentDifficulty)); // 現在の難易度で再スタート
            backToTitleButton.addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                startScreen.style.display = 'flex'; // 初期画面を表示
                obstacles = []; // ゲームデータもリセット
                score = 0;
                scoreDisplay.textContent = `スコア: ${score}`;
            });

            // ウィンドウのリサイズイベント (スマホの向き変更などに対応)
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                // プレイヤー位置も中央に再配置
                player.x = canvas.width / 2 - player.width / 2;
                player.y = canvas.height - 80;
            });

            // 初期表示はスタート画面
            startScreen.style.display = 'flex';
            gameOverScreen.style.display = 'none';
            // ゲームループはstartGame()が呼ばれるまで開始しない

            // 現在選択されている難易度を保持する変数
            let currentDifficulty = 'normal'; // デフォルトは「ふつう」
            easyButton.addEventListener('click', () => { currentDifficulty = 'easy'; startGame('easy'); });
            normalButton.addEventListener('click', () => { currentDifficulty = 'normal'; startGame('normal'); });
            hardButton.addEventListener('click', () => { currentDifficulty = 'hard'; startGame('hard'); });
        });
    </script>
</body>
</html>
